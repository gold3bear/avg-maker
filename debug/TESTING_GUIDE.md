# 崩溃恢复功能测试指南

## 准备工作

1. 启动开发环境：
```bash
npm run dev
```

2. 打开浏览器开发者工具的控制台，测试工具会自动加载
3. 准备一些测试用的 .ink 文件

## 测试套件

### 1. 刷新防护测试

#### A. 主进程快捷键拦截测试 ✅
**目标**: 验证 Electron 主进程是否正确阻止刷新快捷键

**步骤**:
1. 在编辑器中输入一些文本内容
2. 尝试以下快捷键：
   - `Cmd+R` (macOS) / `Ctrl+R` (Windows/Linux)
   - `F5`
   - `Cmd+Shift+R` / `Ctrl+Shift+R`

**预期结果**:
- 页面不应该刷新
- 控制台显示："页面刷新已被禁用以防止数据丢失"
- 编辑器内容保持不变

#### B. beforeunload 警告测试 ⚠️
**目标**: 验证页面级别的刷新警告

**步骤**:
1. 打开项目或文件
2. 在地址栏手动输入 `javascript:location.reload()` 并按回车
3. 或者在控制台输入 `location.reload()`

**预期结果**:
- 显示确认对话框："您确定要刷新页面吗？这将丢失当前的编辑内容和项目状态。"
- 用户可以选择取消或继续

### 2. 自动保存测试

#### A. 编辑器自动保存测试 ✅
**目标**: 验证编辑内容是否自动保存到磁盘

**步骤**:
1. 打开一个 .ink 文件
2. 在编辑器中输入内容
3. 等待 500ms（自动保存防抖时间）
4. 在外部编辑器中查看文件内容

**预期结果**:
- 文件内容已更新
- 控制台可能显示保存相关日志

#### B. 备份机制测试 ✅
**目标**: 验证文件内容是否备份到 localStorage

**步骤**:
1. 打开一个文件并编辑内容
2. 等待 1000ms（备份防抖时间）
3. 在控制台运行：`window.__DEV_TESTING__.crashRecovery.showRecoveryData()`

**预期结果**:
- 显示包含文件备份的数据
- 备份内容与编辑器内容一致

### 3. 崩溃恢复测试

#### A. 模拟崩溃测试 🔥
**目标**: 验证程序崩溃后的数据恢复

**步骤**:
1. 打开项目和文件
2. 在编辑器中输入一些内容
3. 切换一些界面状态（侧边栏、视图等）
4. 等待几秒让数据备份
5. 在控制台运行：`window.__DEV_TESTING__.crashRecovery.simulateCrash()`
6. 应用会关闭，重新启动应用

**预期结果**:
- 重新启动后显示崩溃恢复模态框
- 模态框中显示可恢复的文件和状态
- 选择恢复后，数据应该正确恢复

#### B. 手动强制关闭测试 🔥
**目标**: 验证强制关闭程序后的恢复

**步骤**:
1. 重复上述 A 测试的前 4 步
2. 直接通过任务管理器或 `kill` 命令强制关闭 Electron 进程
3. 重新启动应用

**预期结果**:
- 同 A 测试的预期结果

### 4. 断电模拟测试

#### A. localStorage 持久化测试 💽
**目标**: 验证数据在系统重启后是否保持

**步骤**:
1. 完成崩溃恢复测试的数据准备步骤
2. 在控制台查看数据：`window.__DEV_TESTING__.crashRecovery.showRecoveryData()`
3. 关闭浏览器和应用
4. 重启电脑（或至少重启浏览器）
5. 重新启动应用

**预期结果**:
- 数据依然存在且可以恢复
- 显示崩溃恢复模态框

### 5. 恢复UI测试

#### A. 恢复模态框功能测试 🎯
**目标**: 验证恢复界面的各项功能

**步骤**:
1. 触发崩溃恢复模态框
2. 测试以下功能：
   - 文件选择/取消选择
   - 全选/全不选按钮
   - 项目状态恢复选项
   - 恢复按钮（部分选择）
   - 放弃恢复按钮

**预期结果**:
- 所有交互功能正常工作
- 恢复操作按预期执行
- 放弃恢复会清理数据

### 6. 边界情况测试

#### A. 大文件恢复测试 📄
**步骤**:
1. 创建或编辑一个大文件（>1MB）
2. 执行崩溃恢复流程

**预期结果**:
- 大文件内容正确恢复
- 性能可接受

#### B. 多文件恢复测试 📚
**步骤**:
1. 同时编辑 3-5 个不同的文件
2. 执行崩溃恢复流程

**预期结果**:
- 所有文件都出现在恢复列表中
- 可以选择性恢复
- 恢复内容正确

#### C. 过期数据清理测试 🗑️
**步骤**:
1. 手动修改 localStorage 中的时间戳（设置为 25 小时前）
2. 重新启动应用

**预期结果**:
- 过期数据被自动清理
- 不显示恢复模态框

## 调试工具

### 控制台命令

在开发模式下，以下命令可用于调试：

```javascript
// 查看当前恢复数据
window.__DEV_TESTING__.crashRecovery.showRecoveryData()

// 模拟崩溃
window.__DEV_TESTING__.crashRecovery.simulateCrash()

// 清除所有恢复数据
window.__DEV_TESTING__.crashRecovery.clearAllData()

// 手动备份文件
window.__DEV_TESTING__.crashRecovery.forceBackup('/path/to/file.ink', 'content')
```

### localStorage 检查

在浏览器开发者工具的 Application/存储 标签页中，检查：
- `avg-master-recovery`: 应用状态数据
- `avg-master-file-backups`: 文件备份数据
- `avg-master-session-id`: 会话ID

## 测试检查清单

- [ ] Cmd+R / Ctrl+R 被阻止
- [ ] F5 被阻止  
- [ ] Cmd+Shift+R / Ctrl+Shift+R 被阻止
- [ ] beforeunload 警告显示
- [ ] 编辑内容自动保存到磁盘
- [ ] 编辑内容备份到 localStorage
- [ ] 应用状态定期保存
- [ ] 崩溃后显示恢复模态框
- [ ] 恢复模态框功能完整
- [ ] 文件内容正确恢复
- [ ] 应用状态正确恢复
- [ ] 选择性恢复功能
- [ ] 过期数据自动清理
- [ ] 正常退出时数据清理
- [ ] 多文件恢复
- [ ] 大文件恢复
- [ ] 系统重启后数据保持

## 故障排除

如果测试失败，检查：
1. 浏览器是否支持 localStorage
2. 控制台是否有错误信息
3. Electron 版本是否支持相关 API
4. 文件系统权限是否正确
5. 开发环境配置是否正确

## 性能测试

监控以下指标：
- 备份操作对编辑性能的影响
- localStorage 大小限制
- 恢复操作的速度
- 内存使用情况