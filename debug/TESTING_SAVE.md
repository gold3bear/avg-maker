# Cmd+S 保存功能测试指南

## 🔧 实现的改进

我们已经对Cmd+S键盘保存功能进行了以下改进：

### 1. 多层键盘监听
- **Monaco编辑器命令**: 直接在Monaco编辑器中注册的Cmd+S快捷键
- **全局备用监听**: 当编辑器有焦点时的全局键盘监听
- **焦点感知**: 只在编辑器区域有焦点时响应Cmd+S

### 2. 详细的调试日志
- 键盘事件触发日志
- 保存过程详细追踪
- 错误处理和状态反馈

### 3. 兼容性处理
- 支持macOS (Cmd+S) 和 Windows/Linux (Ctrl+S)
- 防止与系统默认行为冲突
- 确保不与页面刷新保护冲突

## 🧪 测试步骤

### 基本测试
1. **启动应用**: `npm run dev`
2. **打开项目**: 点击"Open Project"选择一个包含.ink文件的项目
3. **打开文件**: 在左侧文件树中点击一个.ink文件
4. **编辑内容**: 在编辑器中进行一些修改
5. **保存测试**: 按 `Cmd+S` (macOS) 或 `Ctrl+S` (Windows/Linux)

### 预期行为
- ✅ 控制台应该显示调试信息：
  ```
  🔧 Editor: 注册Cmd+S快捷键
  ⌨️ Editor: Cmd+S 被触发 (或 全局备用Cmd+S监听被触发)
  💾 Editor: handleSave 被调用
  💾 Editor: 开始保存文件...
  ✅ Editor: 手动保存成功
  ```
- ✅ 标题栏的未保存标识应该消失
- ✅ 文件应该实际保存到磁盘

### 故障排除

#### 如果Cmd+S没有响应：
1. **检查编辑器焦点**: 确保点击了编辑器区域
2. **查看控制台**: 打开开发者工具查看调试日志
3. **检查文件状态**: 确保有文件被打开且有内容变更

#### 常见问题：
- **没有文件路径**: 确保选择了一个具体的.ink文件
- **内容为空**: 确保编辑器中有内容
- **权限问题**: 确保有文件写入权限

## 🔍 调试信息

按 `Cmd+S` 后，在控制台中寻找以下日志：

```
⌨️ App: 检测到Cmd+S，允许通过
🔧 Editor: 编辑器获得焦点，添加键盘监听
⌨️ Editor: 全局备用Cmd+S监听被触发
💾 Editor: handleSave 被调用 {filePath: "/path/to/file.ink", hasContent: true}
💾 Editor: 开始保存文件... /path/to/file.ink
✅ Editor: 手动保存成功 /path/to/file.ink
```

## 🚨 如果仍然无效

1. **重启应用**: 有时需要重新启动开发服务器
2. **清除缓存**: 清除浏览器缓存或重新构建项目
3. **检查系统**: 确认操作系统的Cmd+S没有被其他应用占用
4. **手动保存**: 可以通过工具栏的保存按钮进行保存

## 📝 技术细节

### 实现的键盘监听机制：
1. Monaco编辑器内置命令系统
2. 全局document事件监听（capture模式）
3. 焦点检测确保只在编辑器区域生效
4. 防止与页面刷新保护冲突

### 保存流程：
1. 键盘事件触发 → handleSave
2. 检查文件路径和内容有效性
3. 调用 SaveContext 的 saveFile 方法
4. 通过 window.inkAPI.writeFile 写入文件
5. 更新文件状态为已保存