# 文件保存功能测试指南

## 功能概述

我们已经实现了完整的文件保存系统，包括：
1. **未保存状态追踪** - 实时追踪文件的修改状态
2. **UI 指示器** - 在标题栏和文件树中显示未保存文件
3. **自动保存** - 500ms 防抖自动保存到磁盘
4. **手动保存** - `Cmd+S` / `Ctrl+S` 快捷键保存
5. **关闭确认** - 关闭窗口时提示保存未保存的文件

## 测试步骤

### 1. 基础保存功能测试

#### A. 自动保存测试 ✅
**步骤**:
1. 启动应用：`npm run dev`
2. 打开一个 .ink 文件
3. 在编辑器中修改内容
4. 等待 500ms（自动保存防抖时间）
5. 在外部编辑器中查看文件

**预期结果**:
- 文件内容已自动更新
- 标题栏的"未保存"指示器消失
- 文件树中的橙色圆点消失

#### B. 手动保存测试 ✅
**步骤**:
1. 修改文件内容
2. 立即按 `Cmd+S` (macOS) 或 `Ctrl+S` (Windows/Linux)

**预期结果**:
- 控制台显示"✅ 手动保存成功"
- 文件立即保存到磁盘
- UI 指示器更新

### 2. UI 指示器测试

#### A. 标题栏指示器 ✅
**步骤**:
1. 修改文件内容
2. 观察标题栏中间部分

**预期结果**:
- 标题右侧出现橙色圆点和"未保存"文字
- 鼠标悬停显示未保存文件数量

#### B. 文件树指示器 ✅
**步骤**:
1. 修改文件内容
2. 观察项目资源管理器中的文件

**预期结果**:
- 修改的文件右侧出现橙色圆点
- 鼠标悬停显示"未保存的更改"

### 3. 多文件管理测试

#### A. 多文件编辑测试 📚
**步骤**:
1. 打开文件 A，修改内容
2. 打开文件 B，修改内容
3. 打开文件 C，修改内容
4. 观察 UI 指示器

**预期结果**:
- 标题栏显示"未保存"和总计数量
- 文件树中所有修改的文件都有橙色圆点
- 每个文件的状态独立追踪

#### B. 选择性保存测试 💾
**步骤**:
1. 准备多个未保存的文件
2. 打开其中一个文件
3. 按 `Cmd+S` 保存当前文件
4. 观察 UI 变化

**预期结果**:
- 只有当前文件被保存
- 该文件的指示器消失
- 其他未保存文件的指示器保持

### 4. 窗口关闭确认测试

#### A. 有未保存文件时关闭 ⚠️
**步骤**:
1. 修改一些文件但不保存
2. 点击窗口的关闭按钮（红色 X）

**预期结果**:
- 弹出保存确认对话框
- 对话框列出所有未保存的文件
- 显示每个文件的路径和最后保存时间

#### B. 保存确认对话框功能测试 🎯
**测试选项**:

**保存全部并关闭**:
1. 点击"保存全部"按钮
2. 等待保存完成

**预期结果**: 所有文件保存成功，应用关闭

**不保存直接关闭**:
1. 点击"不保存"按钮

**预期结果**: 不保存更改，应用关闭

**取消关闭**:
1. 点击"取消"按钮

**预期结果**: 返回应用，窗口不关闭

#### C. 无未保存文件时关闭 ✅
**步骤**:
1. 确保所有文件都已保存
2. 点击窗口关闭按钮

**预期结果**:
- 应用直接关闭
- 不显示保存确认对话框

### 5. 错误处理测试

#### A. 保存失败测试 ❌
**步骤**:
1. 修改文件内容
2. 改变文件权限为只读（或移除文件）
3. 触发保存操作

**预期结果**:
- 控制台显示保存失败错误
- UI 指示器保持显示未保存状态
- 不会误导用户认为已保存

#### B. 网络或磁盘错误测试 💥
**步骤**:
1. 在网络驱动器或 USB 设备上测试
2. 在保存过程中断开连接
3. 观察错误处理

**预期结果**:
- 优雅的错误处理
- 保持数据完整性

### 6. 性能测试

#### A. 大文件测试 📄
**步骤**:
1. 创建或打开大文件（>1MB）
2. 进行编辑操作
3. 测试保存性能

**预期结果**:
- 编辑响应流畅
- 保存操作在合理时间内完成
- UI 不卡顿

#### B. 频繁编辑测试 ⚡
**步骤**:
1. 快速连续编辑文件
2. 观察防抖保存行为
3. 检查性能表现

**预期结果**:
- 防抖机制正常工作
- 不会产生过多的保存请求
- 最终状态正确

### 7. 集成测试

#### A. 与崩溃恢复的配合 🔄
**步骤**:
1. 修改文件但不保存
2. 模拟应用崩溃
3. 重新启动应用

**预期结果**:
- 崩溃恢复正常工作
- 文件状态正确恢复
- 两个系统不冲突

#### B. 与主题系统的配合 🎨
**步骤**:
1. 在不同主题下测试保存功能
2. 切换主题时观察 UI 指示器

**预期结果**:
- 指示器在所有主题下都清晰可见
- 颜色和样式适配主题

## 调试工具

### 控制台命令

```javascript
// 查看所有文件状态
console.log('File statuses:', window.__saveContext?.fileStatuses);

// 检查是否有未保存的文件
console.log('Has unsaved changes:', window.__saveContext?.hasUnsavedChanges());

// 获取未保存的文件列表
console.log('Unsaved files:', window.__saveContext?.getUnsavedFiles());
```

### 开发者工具检查

在 React DevTools 中查看：
- `SaveProvider` 的状态
- `useSave` hook 的返回值
- 组件重渲染情况

## 测试检查清单

- [ ] 文件修改后显示未保存指示器
- [ ] 自动保存功能正常（500ms 防抖）
- [ ] 手动保存快捷键工作（Cmd+S / Ctrl+S）
- [ ] 保存后指示器消失
- [ ] 标题栏显示未保存状态和计数
- [ ] 文件树显示未保存文件的橙色圆点
- [ ] 多文件状态独立追踪
- [ ] 窗口关闭时显示保存确认对话框
- [ ] 保存确认对话框功能完整
- [ ] 无未保存文件时直接关闭
- [ ] 保存失败时错误处理正确
- [ ] 大文件和频繁编辑性能良好
- [ ] 与崩溃恢复系统兼容
- [ ] 在所有主题下 UI 正常显示

## 故障排除

1. **指示器不显示**: 检查 SaveProvider 是否正确包装组件
2. **保存不生效**: 检查文件权限和路径
3. **快捷键无效**: 确认 Monaco Editor 正确注册快捷键
4. **对话框不弹出**: 检查窗口关闭事件处理
5. **状态同步问题**: 检查 React Context 和 hooks 使用

## 已知限制

1. 文件在外部被修改时需要手动刷新
2. 保存状态在应用重启后不持久化（这是设计行为）
3. 非常大的文件可能影响性能

这个保存系统为用户提供了现代编辑器应有的文件管理体验，确保数据安全和操作便捷。